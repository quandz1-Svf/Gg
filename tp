--// SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LP = Players.LocalPlayer
local PG = LP:WaitForChild("PlayerGui")

--// FILE
local FILE_NAME = "Saved_TP_Positions.json"

--// CLEAN GUI
if PG:FindFirstChild("TP_Position_Manager") then
    PG.TP_Position_Manager:Destroy()
end

--// GUI
local gui = Instance.new("ScreenGui", PG)
gui.Name = "TP_Position_Manager"
gui.ResetOnSpawn = false

-- MENU BUTTON
local menuBtn = Instance.new("TextButton", gui)
menuBtn.Size = UDim2.new(0,60,0,25)
menuBtn.Position = UDim2.new(0,5,0.45,0)
menuBtn.Text = "TP"
menuBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
menuBtn.TextColor3 = Color3.new(1,1,1)
menuBtn.Draggable = true

-- MAIN FRAME
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,260,0,320)
frame.Position = UDim2.new(0.5,-130,0.5,-160)
frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
frame.Visible = false
frame.Active = true
frame.Draggable = true

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,30)
title.Text = "TP POSITION MANAGER"
title.TextScaled = true
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundColor3 = Color3.fromRGB(35,35,35)

-- NAME BOX
local nameBox = Instance.new("TextBox", frame)
nameBox.Size = UDim2.new(1,-20,0,28)
nameBox.Position = UDim2.new(0,10,0,40)
nameBox.PlaceholderText = "Tên vị trí..."
nameBox.BackgroundColor3 = Color3.fromRGB(30,30,30)
nameBox.TextColor3 = Color3.new(1,1,1)

-- SAVE BUTTON
local saveBtn = Instance.new("TextButton", frame)
saveBtn.Size = UDim2.new(1,-20,0,28)
saveBtn.Position = UDim2.new(0,10,0,75)
saveBtn.Text = "LƯU VỊ TRÍ"
saveBtn.BackgroundColor3 = Color3.fromRGB(0,120,0)
saveBtn.TextColor3 = Color3.new(1,1,1)

-- LIST
local list = Instance.new("ScrollingFrame", frame)
list.Size = UDim2.new(1,-20,0,190)
list.Position = UDim2.new(0,10,0,115)
list.CanvasSize = UDim2.new(0,0,0,0)
list.ScrollBarImageTransparency = 0
list.BackgroundColor3 = Color3.fromRGB(15,15,15)

local layout = Instance.new("UIListLayout", list)
layout.Padding = UDim.new(0,5)

-- AUTO SCROLL UPDATE
layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    list.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 5)
end)

--// DATA
local savedPositions = {}

-- GET ROOT
local function getRoot()
    local char = LP.Character
    return char and char:FindFirstChild("HumanoidRootPart")
end

-- SAVE FILE
local function saveToFile()
    if writefile then
        writefile(FILE_NAME, HttpService:JSONEncode(savedPositions))
    end
end

-- LOAD FILE
local function loadFromFile()
    if isfile and isfile(FILE_NAME) then
        local data = HttpService:JSONDecode(readfile(FILE_NAME))
        savedPositions = data
        for _,v in ipairs(data) do
            addEntry(v.name, CFrame.new(unpack(v.cf)))
        end
    end
end

-- ADD ENTRY
function addEntry(name, cf)
    local item = Instance.new("Frame", list)
    item.Size = UDim2.new(1,-5,0,30)
    item.BackgroundTransparency = 1

    local tpBtn = Instance.new("TextButton", item)
    tpBtn.Size = UDim2.new(0.8,0,1,0)
    tpBtn.Text = name
    tpBtn.BackgroundColor3 = Color3.fromRGB(45,45,45)
    tpBtn.TextColor3 = Color3.new(1,1,1)

    local delBtn = Instance.new("TextButton", item)
    delBtn.Size = UDim2.new(0.2,-5,1,0)
    delBtn.Position = UDim2.new(0.8,5,0,0)
    delBtn.Text = "X"
    delBtn.BackgroundColor3 = Color3.fromRGB(140,0,0)
    delBtn.TextColor3 = Color3.new(1,1,1)

    tpBtn.MouseButton1Click:Connect(function()
        local root = getRoot()
        if root then root.CFrame = cf end
    end)

    delBtn.MouseButton1Click:Connect(function()
        for i,v in ipairs(savedPositions) do
            if v.name == name then
                table.remove(savedPositions, i)
                break
            end
        end
        saveToFile()
        item:Destroy()
    end)
end

-- SAVE BUTTON
saveBtn.MouseButton1Click:Connect(function()
    local root = getRoot()
    if not root then return end

    local name = nameBox.Text ~= "" and nameBox.Text or ("Pos "..(#savedPositions+1))
    local cf = {root.CFrame:GetComponents()}

    table.insert(savedPositions, {name=name, cf=cf})
    addEntry(name, CFrame.new(unpack(cf)))
    saveToFile()

    nameBox.Text = ""
end)

-- MENU TOGGLE
menuBtn.MouseButton1Click:Connect(function()
    frame.Visible = not frame.Visible
end)

-- LOAD SAVED DATA
task.wait(1)
loadFromFile()